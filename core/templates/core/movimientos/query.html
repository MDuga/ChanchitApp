{% extends "core/base.html" %}
{% load widget_tweaks %}

{% block title %} Consultar Movimientos {% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- === COLUMNA IZQUIERDA === -->
    <div class="col-md-8">
      
      <!-- Filtros -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="card shadow-sm border-0">
            <div class="card-body py-3 px-3">
              <h6 class="card-title text-center fw-bold text-primary">üìÖ Consulta por mes</h6>
              <form method="get" class="row g-2">
                <div class="col-6">
                  <label class="form-label small fw-semibold">Mes</label>
                  {{ form_mes.month|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-6">
                  <label class="form-label small fw-semibold">A√±o</label>
                  {{ form_mes.year|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-12 mt-2">
                  <button type="submit" class="btn btn-primary btn-sm w-100">Consultar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="card shadow-sm border-0">
            <div class="card-body py-3 px-3">
              <h6 class="card-title text-center fw-bold text-primary">üìÜ Consulta por fecha</h6>
              <form method="get" class="row g-2">
                <div class="col-6">
                  <label class="form-label small fw-semibold">Inicio</label>
                  {{ form_fechas.inicio|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-6">
                  <label class="form-label small fw-semibold">Fin</label>
                  {{ form_fechas.fin|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-12 mt-2">
                  <button type="submit" class="btn btn-primary btn-sm w-100">Consultar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      {% if saldo_inicial is not None %}
      <div class="card shadow-sm border-0 mt-3">
        <div class="card-body p-3">
          <h6 class="fw-bold mb-1 text-primary">üíº Saldo al inicio:</h6>
          <p class="mb-3"><strong>{{ saldo_inicial }} UYU</strong></p>

         {% if movimientos %}
          <table class="table table-sm table-striped table-bordered align-middle text-center mb-3">
            <thead class="table-dark small">
              <tr>
                <th>Tipo</th>
                <th>Fecha</th>
                <th>Descripci√≥n</th>
                <th>Categor√≠a</th>
                <th>Monto</th>
                <th>Acciones</th>  <!-- üëà Nueva columna -->
              </tr>
            </thead>
            <tbody class="small">
              {% for mov in movimientos %}
              <tr>
                <td>{{ mov.tipo_modelo }}</td>
                <td>{{ mov.date_movimiento|date:"d/m/Y" }}</td>
                <td>{{ mov.descripcion }}</td>
                <td>{{ mov.get_categoria_display }}</td>
                <td class="{% if mov.monto >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ mov.monto }}
                </td>
                <td>
                  {% if mov.tipo_modelo == "Ingresos" or mov.tipo_modelo == "Ingreso" %}
                    <a href="{% url 'update_ingreso' mov.uuid %}" class="btn btn-sm btn-outline-warning me-1" title="Editar ingreso">‚úèÔ∏è</a>
                    <a href="{% url 'delete_ingreso' mov.uuid %}" class="btn btn-sm btn-outline-danger" title="Eliminar ingreso">üóëÔ∏è</a>
                  {% elif mov.tipo_modelo == "Egresos" or mov.tipo_modelo == "Egreso" %}
                    <a href="{% url 'update_egreso' mov.uuid %}" class="btn btn-sm btn-outline-warning me-1" title="Editar egreso">‚úèÔ∏è</a>
                    <a href="{% url 'delete_egreso' mov.uuid %}" class="btn btn-sm btn-outline-danger" title="Eliminar egreso">üóëÔ∏è</a>
                  {% else %}
                    <span class="text-muted small">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted text-center small">No hay movimientos para este per√≠odo.</p>
        {% endif %}


          <h6 class="fw-bold mb-1 text-primary">üìä Saldo final:</h6>
          <h4 class="text-center {% if saldo_final >= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
            {{ saldo_final }} UYU
          </h4>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- === COLUMNA DERECHA: DASHBOARD === -->
<div class="col-md-4">

  <!-- Ingresos vs Egresos -->
  <div class="card shadow-sm border-0 p-3 mb-3 fixed-card">
    <h6 class="text-center fw-bold text-info">Ingresos vs Egresos</h6>
    <canvas id="comparativoChart"></canvas>
  </div>

  <!-- % de Ahorro -->
  <div class="card shadow-sm border-0 p-3 mb-3 fixed-card">
    <h6 class="text-center fw-bold text-success">% de Ahorro</h6>
    <canvas id="ahorroChart"></canvas>
  </div>


  <!-- Distribuci√≥n por Categor√≠a -->
  <div class="card shadow-sm border-0 p-3 fixed-card">
    <h6 class="text-center fw-bold text-primary">Distribuci√≥n de Gastos</h6>
    <canvas id="egresosChart"></canvas>
  </div>

</div>
</div>
</div>

<style>
  body { font-size: 0.9rem; }
  .card { border-radius: 10px; }
  .table th, .table td { padding: 4px 6px !important; }
  .btn-sm { font-size: 0.8rem; border-radius: 6px; }
  h5, h6 { margin-bottom: 0.3rem !important; }

  /* --- DASHBOARD CARDS --- */
.fixed-card {
  height: 260px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.fixed-card canvas {
  flex-grow: 1;
  max-height: 200px;
}
</style>

<!-- Chart.js principal -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plugin para mostrar valores dentro de los gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // Ingresos vs Egresos
  new Chart(document.getElementById('comparativoChart'), {
    type: 'bar',
    data: {
      labels: ['Ingresos', 'Egresos'],
      datasets: [{
        data: [{{ ingresos_total }}, {{ egresos_total }}],
        backgroundColor: ['#81C784', '#E57373']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });

    // % de Ahorro
    new Chart(document.getElementById('ahorroChart'), {
      type: 'pie',
      data: {
        labels: ['Ahorrado', 'Gastado'],
        datasets: [{
          data: [Number({{ ahorro_porcentaje }}), Number({{ gasto }})],
          backgroundColor: ['#81C784', '#FFB74D'], 
          borderColor: '#ffffff',
          borderWidth: 2
        }]
      },
      options: {
        plugins: {
          legend: { display: true, position: 'bottom' },
          datalabels: {
            color: '#fff',
            formatter: (value) => value.toFixed(1) + '%',
            font: { weight: 'bold', size: 14 }
          }
        }
      },
      plugins: [ChartDataLabels]
    });


  // ü•ß Distribuci√≥n de Gastos (agrupada por categor√≠a, en %)
  (() => {
    const categorias = {{ egresos_categorias|safe }};
    const montos = {{ egresos_monto_categoria|safe }};

    // Convertir a positivos y agrupar por categor√≠a
    const agrupados = {};
    categorias.forEach((cat, i) => {
      const valor = Math.abs(montos[i]);
      agrupados[cat] = (agrupados[cat] || 0) + valor;
    });

    // Obtener arrays finales
    const categoriasUnicas = Object.keys(agrupados);
    const montosAgrupados = Object.values(agrupados);

    const total = montosAgrupados.reduce((a, b) => a + b, 0);
    const porcentajes = montosAgrupados.map(v => ((v / total) * 100).toFixed(1));

    if (total > 0) {
      new Chart(document.getElementById('egresosChart'), {
        type: 'bar',
        data: {
          labels: categoriasUnicas,
          datasets: [{
            data: porcentajes,
            backgroundColor: '#36a2eb'
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.x + '%'
              }
            },
            datalabels: {
              color: '#fff',
              formatter: v => v + '%',
              font: { weight: 'bold', size: 12 }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: { display: true, text: '% del total de egresos' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    } else {
      const ctx = document.getElementById('egresosChart');
      const cardBody = ctx.parentElement;
      cardBody.innerHTML = `
        <h6 class="text-center fw-bold text-primary mb-2">Distribuci√≥n de Gastos</h6>
        <div class="d-flex justify-content-center align-items-center" style="height:180px;">
          <p class="text-muted fw-bold mb-0">Sin datos de egresos para mostrar</p>
        </div>`;
    }
  })();


}); 
</script>
{% endblock %}

